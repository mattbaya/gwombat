# GWOMBAT CSV Export System

## Overview

GWOMBAT includes a comprehensive CSV export system that allows you to export any data displayed in the system to CSV format for external analysis, reporting, and integration with other tools.

## Features

### ðŸ“Š Comprehensive Export Coverage
- **User Data** - All users, suspended users, active users, custom queries
- **Shared Drive Data** - Complete shared drive listings with metadata  
- **Account Lists** - Export database-managed account lists
- **Custom GAM Queries** - Export results from any GAM command
- **Automated Integration** - Export prompts appear automatically after data queries

### ðŸ—‚ï¸ Export Management
- **Organized Storage** - All exports saved to `local-config/exports/` directory
- **Automatic Naming** - Timestamp-based filenames with descriptive prefixes
- **Metadata Inclusion** - Export timestamps, descriptions, and record counts
- **File Cleanup** - Built-in tools to manage old export files

## Accessing CSV Export

### Method 1: Integrated Export Prompts
When you run user queries that display data, GWOMBAT automatically offers to export:

```bash
# After running any user query, you'll see:
Export this data to CSV? (y/N): 
```

### Method 2: Dedicated Export Menu
Navigate to: **File & Drive Operations â†’ CSV Data Export**

```bash
./gwombat.sh
# Select: Data & File Operations
# Select: CSV Data Export
```

## Export Menu Options

### 1. ðŸ‘¥ Export All Users
Exports complete user directory with all user attributes.

**GAM Command**: `gam print users`
**Output**: `users_all_YYYYMMDD_HHMMSS.csv`

### 2. ðŸš« Export Suspended Users
Exports only suspended user accounts.

**GAM Command**: `gam print users suspended`
**Output**: `users_suspended_YYYYMMDD_HHMMSS.csv`

### 3. âœ… Export Active Users  
Exports only active (non-suspended) user accounts.

**GAM Command**: `gam print users query "isSuspended=false"`
**Output**: `users_active_YYYYMMDD_HHMMSS.csv`

### 4. ðŸ—‚ï¸ Export Shared Drives
Exports complete shared drive directory.

**GAM Command**: `gam print teamdrives`
**Output**: `shared_drives_YYYYMMDD_HHMMSS.csv`

### 5. ðŸ“‹ Export Account List (from database)
Exports account lists managed in GWOMBAT's database.

**Source**: SQLite database query
**Output**: `account_list_[LIST_NAME]_YYYYMMDD_HHMMSS.csv`

### 6. ðŸ“Š Export Custom GAM Query
Execute and export any custom GAM command.

**Interactive**: Prompts for GAM command
**Output**: `custom_query_[SANITIZED_QUERY]_YYYYMMDD_HHMMSS.csv`

### 7. ðŸ“ Open Exports Folder
Opens the exports directory in your file manager.

### 8. ðŸ§¹ Clean Old Export Files
Removes export files older than 30 days.

## CSV File Format

### Standard Structure
```csv
# Header row (if available from GAM)
primaryEmail,name,orgUnitPath,suspended,creationTime
user1@domain.edu,John Doe,/Students,False,2024-08-15T10:30:00.000Z
user2@domain.edu,Jane Smith,/Faculty,False,2024-07-20T14:45:00.000Z

# GWOMBAT Metadata (at end of file)
# Export generated by GWOMBAT on Thu Aug 19 10:30:45 PDT 2025
# Description: All Google Workspace users  
# GAM command: gam print users
# Total records: 1247
```

### Metadata Fields
- **Export Timestamp** - When the export was generated
- **Description** - What the export contains
- **Source Command** - GAM command used (if applicable)
- **Record Count** - Number of exported records

## Integration with User Queries

The CSV export system is integrated into these user query functions:

### query_all_suspended_users()
After displaying suspended users from all OUs, offers export of combined data:
```bash
Export this data to CSV? (y/N): y
âœ“ Export completed successfully
  File: /path/to/gwombat/local-config/exports/suspended_users_20250819_103045.csv
  Size: 24K
  Records: 156
```

### query_users_by_department()  
After displaying department users (active and suspended), offers export:
```bash
Export this data to CSV? (y/N): y
âœ“ Export completed successfully
  File: /path/to/gwombat/local-config/exports/Faculty_users_20250819_103045.csv
  Size: 12K  
  Records: 87
```

### query_users_custom()
After displaying custom GAM query results, offers export:
```bash
Export this data to CSV? (y/N): y
âœ“ Export completed successfully
  File: /path/to/gwombat/local-config/exports/custom_query_department_Student_20250819_103045.csv
  Size: 45K
  Records: 234  
```

## File Management

### Export Directory Structure
```
local-config/exports/
â”œâ”€â”€ users_all_20250819_103045.csv
â”œâ”€â”€ users_suspended_20250819_103122.csv
â”œâ”€â”€ Faculty_users_20250819_103200.csv
â”œâ”€â”€ shared_drives_20250819_103245.csv
â””â”€â”€ custom_query_department_IT_20250819_103330.csv
```

### Automatic Cleanup
The system includes automatic cleanup functionality:
- **Manual Cleanup**: Export menu option 8
- **30-Day Retention**: Removes files older than 30 days  
- **Confirmation Required**: Asks before deletion
- **Progress Display**: Shows how many files were cleaned

### File Naming Convention
```
[TYPE]_[DETAILS]_YYYYMMDD_HHMMSS.csv

Examples:
users_all_20250819_103045.csv           # All users
users_suspended_20250819_103122.csv     # Suspended users  
Faculty_users_20250819_103200.csv       # Faculty department
shared_drives_20250819_103245.csv       # Shared drives
account_list_TestList_20250819_103300.csv  # Database account list
custom_query_sanitized_20250819_103330.csv # Custom GAM query
```

## Technical Implementation

### Core Functions
- **export_to_csv()** - General-purpose CSV export function
- **export_users_csv()** - User-specific export with GAM integration
- **export_shared_drives_csv()** - Shared drive export
- **export_account_list_csv()** - Database account list export
- **quick_export()** - Integrated export prompt for existing functions

### Integration Pattern
```bash
# Pattern used in user query functions:
local query_results=$($GAM print users query "$custom_query" ...)
echo "$query_results"

# Offer CSV export option
if [[ -n "$query_results" ]] && type quick_export >/dev/null 2>&1; then
    quick_export "$query_results" "query_type" "Description of exported data"
fi
```

### Error Handling
- **GAM Command Failures** - Graceful error messages and fallback
- **Empty Results** - Clear messaging when no data to export
- **File System Issues** - Directory creation and permission handling
- **Function Availability** - Checks for export function availability

## Best Practices

### For Regular Users
1. **Use Descriptive Names** - The system generates good defaults, but consider the purpose
2. **Regular Cleanup** - Use the cleanup function monthly to manage disk space
3. **External Tools Integration** - CSV files work well with Excel, Google Sheets, databases
4. **Backup Important Exports** - Move critical exports outside the temp directory

### For Administrators  
1. **Monitor Export Directory** - Include exports in backup/monitoring
2. **Audit Export Usage** - Track who exports what data for compliance
3. **Set Retention Policies** - Configure automatic cleanup schedules
4. **Integration Planning** - Consider how exports fit into larger workflows

## Troubleshooting

### Common Issues

#### "Export functions not available"
- **Cause**: export_functions.sh not loaded properly
- **Solution**: Restart GWOMBAT or check shared-utilities/export_functions.sh exists

#### "No data to export" 
- **Cause**: Query returned empty results
- **Solution**: Verify GAM connectivity and domain configuration

#### "Permission denied" errors
- **Cause**: Cannot write to exports directory
- **Solution**: Check permissions on local-config/exports/

#### GAM command failures
- **Cause**: GAM not configured or authenticated
- **Solution**: Run GAM configuration in GWOMBAT settings menu

### Getting Help
- Check `docs/OAUTH_TROUBLESHOOTING.md` for GAM authentication issues
- Verify GAM path configuration in system settings
- Test GAM commands manually: `gam info domain`

## Future Enhancements

Planned improvements to the CSV export system:
- **Google Sheets Integration** - Direct upload to Google Sheets
- **Scheduled Exports** - Automated recurring exports  
- **Advanced Filtering** - Pre-export data filtering options
- **Format Options** - JSON, XML, and other export formats
- **Template System** - Customizable export templates
- **Email Integration** - Automatic email delivery of exports

---

The CSV Export System makes GWOMBAT data portable and integrates seamlessly with external analysis tools and workflows.